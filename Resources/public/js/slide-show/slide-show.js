var __extends=this&&this.__extends||function(){var n=function(i,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,e){i.__proto__=e}||function(i,e){for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(i[t]=e[t])})(i,e)};return function(i,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function t(){this.constructor=i}n(i,e),i.prototype=null===e?Object.create(e):(t.prototype=e.prototype,new t)}}();define(["require","exports","underscore","gsap/TimelineLite","./model","json!ekyna-cms/slide-types"],function(i,h,r,a,e,t){"use strict";s.initialize=function(i){s.config=i,s.types={}},s.getType=function(n){return new Promise(function(e,t){if(s.types.hasOwnProperty(n))e(s.types[n]);else if(s.config.hasOwnProperty(n))try{i([s.config[n]],function(i){s.types[n]=new i,e(s.types[n])})}catch(i){t(i)}else t("Undefined type.")})};var l=s;function s(){}l.initialize(t);n.prototype.show=function(){this.timeline.play(0,!1)},n.prototype.hide=function(i){(i=void 0===i?!1:i)?(this.timeline.seek(0,!1),this.timeline.pause()):((i=this.timeline.eventCallback("onReverse"))&&i(),this.timeline.reverse())};var d=n;function n(i){this.timeline=i}var o,u={id:null,types:{},ui:!0,uiHover:!1,uiSpeed:.2,auto:!0,autoDelay:7,debug:!1};function c(){return null!==o&&o.apply(this,arguments)||this}return o=e.Dispatcher,__extends(c,o),c.create=function(i){var e=new c;return e.init(i),e},c.prototype.init=function(i){var t=this;if(this.initialized=!1,this.root=document.getElementById(i.id),this.root){for(var e={},n=(this.root.hasAttribute("data-config")&&(e=JSON.parse(this.root.getAttribute("data-config"))),this.config=r.defaults({},i,e,u),this.slides=[],this.busy=!1,this.autoPlaying=!0,this.root.getElementsByClassName("cms-slides").item(0).children),s=[],o=0;o<n.length;o++)!function(i){var e=n.item(i);e.style.setProperty("display","none"),s.push(l.getType(e.getAttribute("data-type")).then(function(i){return new d(i.build(e,t))}))}(o);Promise.all(s).then(function(i){t.slides=i,t.buildUi(),t.transitionTo(0),t.initialized=!0,t.trigger("ekyna_cms.slide_show.initialized"),t.on("ekyna_cms.slide.timeout",function(){t.nextSlide()}),t.log("initialized")},function(i){console.log(i)})}else console.log("Slide show's root element not found.")},c.prototype.autoNext=function(){this.config.auto&&this.autoPlaying&&this.timerTimeline.restart(!1,!1)},c.prototype.transitionTo=function(i,e){var t,n=this;!(e=void 0===e?!1:e)&&this.busy||this.index===i||(this.initialized?(this.index=i,this.log("show "+this.index),t=this.slides[this.index],e?(this.current&&this.current.hide(!0),this.showSlide(t)):this.current?this.hideSlide(this.current,t):this.showSlide(t)):this.once("ekyna_cms.slide_show.initialized",function(){n.transitionTo(i,e)}))},c.prototype.nextSlide=function(){var i;this.log("next"),this.busy||(i=this.index,++i>=this.slides.length&&(i=0),this.transitionTo(i))},c.prototype.prevSlide=function(){var i;this.log("prev"),this.busy||(i=this.index,--i<0&&(i=this.slides.length-1),this.transitionTo(i))},c.prototype.hideSlide=function(i,e){var t=this;this.busy=!0,this.once("ekyna_cms.slide.hidden",function(){t.showSlide(e)}),i.hide()},c.prototype.showSlide=function(i){var e=this;if(this.busy=!0,this.once("ekyna_cms.slide.shown",function(){e.busy=!1,e.autoNext()}),this.current=i,this.current.show(),this.config.ui){for(var t=0;t<this.nav.children.length;t++)this.nav.children.item(t).classList.remove("active");this.nav.children.item(this.index).classList.add("active")}},c.prototype.buildUi=function(){var n=this;if(this.config.ui&&!(this.slides.length<=1)){this.config.uiHover&&(this.uiTimeline=new a),this.nav=document.createElement("ul");for(var i,s=.1,o=this,e=0;e<this.slides.length;e++)!function(i){var e=document.createElement("li"),t=document.createElement("a");t.href="javascript: void(0)",t.classList.add("slide"),t.addEventListener("click",function(){n.busy||(n.timerTimeline.pause(),n.transitionTo(i))}),e.appendChild(t),o.nav.appendChild(e),o.config.uiHover&&o.uiTimeline.from(e,o.config.uiSpeed,{y:20,opacity:0,ease:Back.easeOut},s*i)}(e);this.config.auto&&(t=document.createElement("li"),(i=document.createElement("a")).href="javascript: void(0)",i.classList.add("play"),i.classList.add("pause"),i.addEventListener("click",function(){n.busy||(n.autoPlaying=!n.autoPlaying,n.autoPlaying?(i.classList.add("pause"),n.timerTimeline.resume()):(i.classList.remove("pause"),n.timerTimeline.pause()))}),t.appendChild(i),this.nav.appendChild(t),this.config.uiHover&&this.uiTimeline.from(t,this.config.uiSpeed,{y:20,opacity:0,ease:Back.easeOut},s*this.slides.length));var t=document.createElement("div"),t=(t.classList.add("cms-slide-show-nav"),t.appendChild(this.nav),this.root.appendChild(t),document.createElement("div")),t=(t.classList.add("cms-slide-show-timer"),this.root.appendChild(t),this.timerTimeline=new a,this.timerTimeline.to(t,this.config.autoDelay,{width:"100%",ease:Power0.easeNone,onComplete:function(){n.trigger("ekyna_cms.slide.timeout")}}),this.timerTimeline.to(t,.15,{opacity:0}),this.timerTimeline.pause(),document.createElement("a")),r=document.createElement("a");t.classList.add("cms-slide-show-prev"),t.href="javascript: void(0)",t.addEventListener("click",function(){n.timerTimeline.pause(),n.prevSlide()}),this.root.appendChild(t),r.classList.add("cms-slide-show-next"),r.href="javascript: void(0)",r.addEventListener("click",function(){n.timerTimeline.pause(),n.nextSlide()}),this.root.appendChild(r),this.config.uiHover&&(this.uiTimeline.from(t,this.config.uiSpeed,{x:"-100% 0"},0),this.uiTimeline.from(r,this.config.uiSpeed,{x:"100% 0"},0),this.uiTimeline.pause(),this.root.addEventListener("mouseenter",function(){n.uiTimeline.play()}),this.root.addEventListener("mouseleave",function(){n.uiTimeline.reverse()}))}},c.prototype.log=function(i){this.config.debug&&console.log("[SlideShow]",i)},c});