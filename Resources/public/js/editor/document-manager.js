define(["require","exports","jquery","es6-promise","routing","./dispatcher","./ui"],function(a,b,c,d,e,f,g){"use strict";d.polyfill();var h=d.Promise,i=function(){function a(){}return a.setWindow=function(a){this.window=a},a.setDocument=function(a){this.$document=a},a.findElementById=function(a){return this.$document.find("#"+a)},a.createElement=function(a,b){if(!b)throw"Undefined parent.";return c("<div></div>").attr("id",a).appendTo(b)},a.findOrCreateElement=function(a,b){var c=this.findElementById(a);return 0==c.length&&(c=this.createElement(a,b)),c},a.setElementAttributes=function(a,b){a.removeAttr("class").attr("class",b.classes).removeAttr("data-cms").data("cms",b.data),b.style&&a.removeAttr("style").attr("style",b.style)},a.sortChildren=function(a){var b=a.children();b.detach().get().sort(function(a,b){var d=c(a).data("cms").position,e=c(b).data("cms").position;return d==e?0:d>e?1:-1}).forEach(function(b){a.append(b)})},a.request=function(a){var b=this;a=_.extend({method:"POST"},a);var d=c.ajax(a);return d.done(function(a){a.hasOwnProperty("removed")&&a.removed.forEach(function(a){b.$document.find("#"+a).remove()}),a.hasOwnProperty("content")?j.parse(a.content):a.hasOwnProperty("containers")?k.parse(a.containers):a.hasOwnProperty("rows")?l.parse(a.rows):a.hasOwnProperty("blocks")&&m.parse(a.blocks),f["default"].trigger("base_manager.response_parsed",a.hasOwnProperty("created")?a.created:void 0)}),d.fail(function(){throw"Editor request failed."}),d},a}(),j=function(){function a(){}return a.parse=function(a){if(!a.hasOwnProperty("attributes"))throw"Unexpected content data";var b=i.findElementById(a.attributes.id);if(0==b.length)throw"Content not found.";i.setElementAttributes(b,a.attributes),a.hasOwnProperty("containers")&&k.parse(a.containers,b),i.sortChildren(b)},a}();b.ContentManager=j;var k=function(){function a(){}return a.parse=function(a,b){a.forEach(function(c,d){if(!c.hasOwnProperty("attributes"))throw"Unexpected container data";var e=i.findOrCreateElement(c.attributes.id,b);i.setElementAttributes(e,c.attributes);var f=c.hasOwnProperty("content")?c.content:null;if(f&&0<f.length)e.html(c.content);else{var g;c.hasOwnProperty("inner_attributes")?(g=i.findOrCreateElement(c.inner_attributes.id,e),i.setElementAttributes(g,c.inner_attributes)):g=e.find("> .cms-inner-container"),c.hasOwnProperty("rows")&&l.parse(c.rows,g),i.sortChildren(g),b||d!=a.length-1||i.sortChildren(e.closest(".cms-content"))}})},a.request=function(a,b,c){var d=b.data("cms").id;if(!d)throw"Invalid id";return c=c||{},c.url=e.generate(a,{containerId:d}),i.request(c)},a.edit=function(a){n.createContainerPlugin(a.data("cms").type,a)},a.changeType=function(b,c){a.request("ekyna_cms_editor_container_change_type",b,{data:{type:c}})},a.remove=function(b){a.request("ekyna_cms_editor_container_remove",b)},a.add=function(a,b){var c=a.closest(".cms-content");if(1!=c.length)throw"Container content not found.";var d=c.data("cms").id;if(!d)throw"Invalid id";i.request({url:e.generate("ekyna_cms_editor_content_create_container",{contentId:d}),data:{type:b}})},a.moveUp=function(b){a.request("ekyna_cms_editor_container_move_up",b)},a.moveDown=function(b){a.request("ekyna_cms_editor_container_move_down",b)},a}();b.ContainerManager=k;var l=function(){function a(){}return a.parse=function(a,b){a.forEach(function(c,d){if(!c.hasOwnProperty("attributes"))throw"Unexpected row data";var e=i.findOrCreateElement(c.attributes.id,b);i.setElementAttributes(e,c.attributes),c.hasOwnProperty("blocks")&&m.parse(c.blocks,e),i.sortChildren(e),b||d!=a.length-1||i.sortChildren(e.closest(".cms-inner-container"))})},a.request=function(a,b){var c=b.data("cms").id;if(!c)throw"Invalid id";return i.request({url:e.generate(a,{rowId:c})})},a.remove=function(b){a.request("ekyna_cms_editor_row_remove",b)},a.add=function(a){var b=a.closest(".cms-container");if(1!=b.length)throw"Row container not found.";var c=b.data("cms").id;if(!c)throw"Invalid id";i.request({url:e.generate("ekyna_cms_editor_container_create_row",{containerId:c})})},a.moveUp=function(b){a.request("ekyna_cms_editor_row_move_up",b)},a.moveDown=function(b){a.request("ekyna_cms_editor_row_move_down",b)},a}();b.RowManager=l;var m=function(){function a(){}return a.parse=function(a,b){a.forEach(function(c,d){var e,f;c.hasOwnProperty("attributes")&&(e=i.findOrCreateElement(c.attributes.id,b),i.setElementAttributes(e,c.attributes)),c.hasOwnProperty("plugin_attributes")&&(f=i.findOrCreateElement(c.plugin_attributes.id,e),i.setElementAttributes(f,c.plugin_attributes),c.hasOwnProperty("content")&&f.html(c.content)),!f&&!e||b||d!=a.length-1||(e||(e=f.closest(".cms-column")),i.sortChildren(e.closest(".cms-row")))})},a.request=function(a,b,c){var d=b.data("cms").id;if(!d)throw"Invalid id";return c=c||{},c.url=e.generate(a,{blockId:d}),i.request(c)},a.edit=function(a){n.createBlockPlugin(a.data("cms").type,a)},a.changeType=function(b,c){a.request("ekyna_cms_editor_block_change_type",b,{data:{type:c}})},a.remove=function(b){a.request("ekyna_cms_editor_block_remove",b)},a.add=function(a,b){var c=a.closest(".cms-row");if(1!=c.length)throw"Block row not found.";var d=c.data("cms").id;if(!d)throw"Invalid id";i.request({url:e.generate("ekyna_cms_editor_row_create_block",{rowId:d}),data:{type:b}})},a.moveLeft=function(b){a.request("ekyna_cms_editor_block_move_left",b)},a.moveRight=function(b){a.request("ekyna_cms_editor_block_move_right",b)},a.moveUp=function(a){throw"Not yet implemented"},a.moveDown=function(a){throw"Not yet implemented"},a.expand=function(b){a.request("ekyna_cms_editor_block_expand",b)},a.compress=function(b){a.request("ekyna_cms_editor_block_compress",b)},a}();b.BlockManager=m,f["default"].on("block.edit",function(a,b){return m.edit(b.$block)}),f["default"].on("block.change-type",function(a,b){return m.changeType(b.$block,b.type)}),f["default"].on("block.move-left",function(a,b){return m.moveLeft(b.$block)}),f["default"].on("block.move-right",function(a,b){return m.moveRight(b.$block)}),f["default"].on("block.move-up",function(a,b){return m.moveUp(b.$block)}),f["default"].on("block.move-down",function(a,b){return m.moveDown(b.$block)}),f["default"].on("block.expand",function(a,b){return m.expand(b.$block)}),f["default"].on("block.compress",function(a,b){return m.compress(b.$block)}),f["default"].on("block.remove",function(a,b){return m.remove(b.$block)}),f["default"].on("block.add",function(a,b){return m.add(b.$block,b.type)}),f["default"].on("row.move-up",function(a,b){return l.moveUp(b.$row)}),f["default"].on("row.move-down",function(a,b){return l.moveDown(b.$row)}),f["default"].on("row.remove",function(a,b){return l.remove(b.$row)}),f["default"].on("row.add",function(a,b){return l.add(b.$row)}),f["default"].on("container.edit",function(a,b){return k.edit(b.$container)}),f["default"].on("container.change-type",function(a,b){return k.changeType(b.$container,b.type)}),f["default"].on("container.move-up",function(a,b){return k.moveUp(b.$container)}),f["default"].on("container.move-down",function(a,b){return k.moveDown(b.$container)}),f["default"].on("container.remove",function(a,b){return k.remove(b.$container)}),f["default"].on("container.add",function(a,b){return k.add(b.$container,b.type)});var n=function(){function b(){}return b.load=function(a){this.registry=a},b.getActivePlugin=function(){if(!this.hasActivePlugin())throw"Active plugin is not set";return this.activePlugin},b.hasActivePlugin=function(){return!!this.activePlugin},b.clearActivePlugin=function(){var a=this;return this.hasActivePlugin()?this.activePlugin.destroy().then(function(){a.activePlugin=null}):h.resolve()},b.createPlugin=function(b,c,d){var e=this;console.log("PluginManager::createPlugin",b,c,d),this.clearActivePlugin().then(function(){throw b.forEach(function(b){return b.name===c?void a([b.path],function(a){console.log("plugin loaded",a),e.activePlugin=new a(d,i.window),e.activePlugin.edit()}):void 0}),'Plugin "'+c+'" not found.'})},b.createBlockPlugin=function(a,b){this.createPlugin(this.getBlockPluginsConfig(),a,b)},b.createContainerPlugin=function(a,b){this.createPlugin(this.getContainerPluginsConfig(),a,b)},b.getBlockPluginsConfig=function(){if(!this.registry)throw"Plugins registry is not configured";return this.registry.block},b.getContainerPluginsConfig=function(){if(!this.registry)throw"Plugins registry is not configured";return this.registry.container},b}();b.PluginManager=n;var o=function(){function a(){}return a.getToolbar=function(){if(!this.hasToolbar())throw"Toolbar is not set";return this.toolbar},a.hasToolbar=function(){return!!this.toolbar},a.clearToolbar=function(){this.hasToolbar()&&(this.toolbar.remove(),this.toolbar=null)},a.createToolbar=function(a){this.clearToolbar(),this.toolbar=new g.ToolbarView({model:a}),c(document).find("body").append(this.toolbar.render().$el),this.toolbar.postRender()},a.createBlockToolbar=function(a,b){var c=a.closest(".cms-column"),d=c.closest(".cms-row"),e=new g.Toolbar({classes:["vertical","block-toolbar"],origin:b});e.addButton("default",new g.Button({name:"edit",title:"Edit",icon:"pencil",event:"block.edit",data:{$block:a}}));var f=[];n.getBlockPluginsConfig().forEach(function(b){f.push({name:b.name,title:b.title,confirm:"Êtes-vous sûr de vouloir changer le type de ce bloc ? (Le contenu actuel sera définitivement perdu).",event:"block.change-type",data:{$block:a,type:b.name}})}),e.addButton("default",new g.Button({name:"change-type",title:"Change type",icon:"cog",choices:f})),1==d.length&&(e.addButton("horizontal",new g.Button({name:"move-left",title:"Move left",icon:"arrow-left",disabled:c.is(":first-child"),event:"block.move-left",data:{$block:a}})),e.addButton("horizontal",new g.Button({name:"move-right",title:"Move right",icon:"arrow-right",disabled:c.is(":last-child"),event:"block.move-right",data:{$block:a}})),e.addButton("resize",new g.Button({name:"expand",title:"Expand size",icon:"expand",disabled:function(a){var b=a.children(".cms-column").length;return!(b>1&&6>=b)}(d),event:"block.expand",data:{$block:a}})),e.addButton("resize",new g.Button({name:"compress",title:"Compress size",icon:"compress",disabled:1==d.children(".cms-column").length||2>=parseInt(c.data("cms").size),event:"block.compress",data:{$block:a}})),e.addButton("add",new g.Button({name:"remove",title:"Remove",icon:"remove",disabled:1>=d.children(".cms-column").length,confirm:"Êtes-vous sûr de vouloir supprimer ce bloc ?",event:"block.remove",data:{$block:a}})),f=[],n.getBlockPluginsConfig().forEach(function(b){f.push({name:b.name,title:b.title,event:"block.add",data:{$block:a,type:b.name}})}),e.addButton("add",new g.Button({name:"add",title:"Create a new block after this one",icon:"plus",disabled:6<=d.children(".cms-column").length,choices:f}))),this.createToolbar(e)},a.createRowToolbar=function(a,b){var c=a.closest(".cms-inner-container"),d=new g.Toolbar({classes:["vertical","row-toolbar"],origin:b});1==c.length&&(d.addButton("move",new g.Button({name:"move-up",title:"Move up",icon:"arrow-up",disabled:a.is(":first-child"),event:"row.move-up",data:{$row:a}})),d.addButton("move",new g.Button({name:"move-down",title:"Move down",icon:"arrow-down",disabled:a.is(":last-child"),event:"row.move-down",data:{$row:a}})),d.addButton("add",new g.Button({name:"remove",title:"Remove",icon:"remove",disabled:1>=c.children(".cms-row").length,confirm:"Êtes-vous sûr de vouloir supprimer cette ligne ?",event:"row.remove",data:{$row:a}})),d.addButton("add",new g.Button({name:"add",title:"Create a new row",icon:"plus",event:"row.add",data:{$row:a}}))),this.createToolbar(d)},a.createContainerToolbar=function(a,b){var c=a.closest(".cms-content"),d=new g.Toolbar({classes:["vertical","container-toolbar"],origin:b});d.addButton("default",new g.Button({name:"edit",title:"Edit",icon:"pencil",event:"container.edit",data:{$container:a}}));var e=[];n.getContainerPluginsConfig().forEach(function(b){e.push({name:b.name,title:b.title,confirm:"Êtes-vous sûr de vouloir changer le type de ce contener ? (Le contenu actuel sera définitivement perdu).",event:"container.change-type",data:{$container:a,type:b.name}})}),d.addButton("default",new g.Button({name:"change-type",title:"Change type",icon:"cog",choices:e})),1==c.length&&(d.addButton("move",new g.Button({name:"move-up",title:"Move up",icon:"arrow-up",disabled:a.is(":first-child"),event:"container.move-up",data:{$container:a}})),d.addButton("move",new g.Button({name:"move-down",title:"Move down",icon:"arrow-down",disabled:a.is(":last-child"),event:"container.move-down",data:{$container:a}})),d.addButton("add",new g.Button({name:"remove",title:"Remove",icon:"remove",disabled:1>=c.children(".cms-container").length,confirm:"Êtes-vous sûr de vouloir supprimer ce conteneur ?",event:"container.remove",data:{$container:a}})),e=[],n.getContainerPluginsConfig().forEach(function(b){e.push({name:b.name,title:b.title,event:"container.add",data:{$container:a,type:b.name}})}),d.addButton("add",new g.Button({name:"add",title:"Create a new container after this one",icon:"plus",choices:e}))),this.createToolbar(d)},a}(),p=function(){function a(a){var b=this;this.enabled=!1,this.$clickTarget=null,this.clickOrigin=null,this.hostname=a,this.viewportOrigin={top:50,left:0},this.selectionOffset={top:0,left:0},this.selectionId=null,this.documentMouseDownHandler=function(a){return b.onDocumentMouseDown(a)},this.documentMouseUpHandler=function(){return b.onDocumentMouseUp()},this.powerClickHandler=function(a){return b.onPowerClick(a)},this.viewportLoadHandler=function(a,c){return b.onViewportLoad(a,c)},this.viewportUnloadHandler=function(a){return b.onViewportUnload(a)},this.viewportResizeHandler=function(a){return b.onViewportResize(a)}}return a.prototype.initialize=function(){var a=this;f["default"].on("viewport.resize",this.viewportResizeHandler),f["default"].on("base_manager.response_parsed",function(b){var c;b?c=i.findElementById(b):a.selectionId&&(c=i.findElementById(a.selectionId)),a.deselect().then(function(){c&&1==c.length&&a.select(c)})}),f["default"].on("block.edit",function(){return o.clearToolbar()})},a.prototype.onPowerClick=function(a){var b=a.get("active");b&&!this.enabled?(this.enabled=!0,this.enableEdition()):this.enabled&&!b?(this.enabled=!1,this.disableEdition()):this.enabled=b},a.prototype.onViewportLoad=function(a,b){var d=this;return i.setWindow(a),i.setDocument(c(b)),i.$document.find("a[href]").off("click").on("click",function(a){a.preventDefault(),a.stopPropagation();var b=a.currentTarget;b.hostname!==d.hostname?console.log("Attempt to navigate out of the website has been blocked."):f["default"].trigger("document_manager.navigate",b.href)}),this.enabled&&this.enableEdition(),this},a.prototype.onViewportUnload=function(a){return a.defaultPrevented?void 0:n.hasActivePlugin()&&n.getActivePlugin().isUpdated()?(a.preventDefault(),a.returnValue="Vos changements n'ont pas été sauvegardés !",this):(n.clearActivePlugin(),i.setWindow(null),i.setDocument(null),this)},a.prototype.onViewportResize=function(a){return this.viewportOrigin=a,o.hasToolbar()&&o.getToolbar().applyOriginOffset(a),this},a.prototype.onDocumentMouseDown=function(a){this.$clickTarget=null,this.clickOrigin=null;var b={top:a.clientY,left:a.clientX},d=c(a.target);if(!(0<d.closest("#editor-document-toolbar").length||n.hasActivePlugin()&&n.getActivePlugin().preventDocumentSelection(d))){var e=d.closest(".cms-block, .cms-row, .cms-container");1==e.length?e.attr("id")!=this.selectionId&&(this.clickOrigin=b,this.$clickTarget=e):this.clickOrigin=b}},a.prototype.onDocumentMouseUp=function(){var a=this;this.clickOrigin&&this.deselect().then(function(){a.$clickTarget?a.select(a.$clickTarget,a.clickOrigin):a.createToolbar(),a.$clickTarget=null,a.clickOrigin=null})},a.prototype.deselect=function(){var a=this;return n.clearActivePlugin().then(function(){o.clearToolbar(),a.selectionId&&(i.findElementById(a.selectionId).removeClass("selected"),a.selectionId=null)})},a.prototype.select=function(a,b){1==a.length&&(this.selectionId=a.addClass("selected").attr("id"),this.createToolbar(a,b))},a.prototype.createToolbar=function(a,b){if(a=a||i.findElementById(this.selectionId),1==a.length){if(b?this.selectionOffset={top:b.top-a.offset().top,left:b.left-a.offset().left}:b={top:a.offset().top+this.selectionOffset.top,left:a.offset().left+this.selectionOffset.left},a.hasClass("cms-block"))o.createBlockToolbar(a,b);else if(a.hasClass("cms-row"))o.createRowToolbar(a,b);else{if(!a.hasClass("cms-container"))throw"Unexpected element";o.createContainerToolbar(a,b)}o.getToolbar().applyOriginOffset(this.viewportOrigin)}},a.prototype.enableEdition=function(){var a=i.$document;if(this.enabled&&null!==a){if(0==a.find("link#cms-editor-stylesheet").length){var b=document.createElement("link");b.id="cms-editor-stylesheet",b.href="/bundles/ekynacms/css/editor-document.css",b.type="text/css",b.rel="stylesheet",a.find("head").append(b)}return a.on("mousedown",this.documentMouseDownHandler),a.on("mouseup",this.documentMouseUpHandler),this}},a.prototype.disableEdition=function(){var a=i.$document;if(!this.enabled&&null!==a){this.deselect(),a.off("mousedown",this.documentMouseDownHandler),a.off("mouseup",this.documentMouseUpHandler);var b=a.find("link#cms-editor-stylesheet");return b.length&&b.remove(),this}},a}();b.DocumentManager=p});