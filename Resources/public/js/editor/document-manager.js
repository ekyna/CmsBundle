var __extends=this&&this.__extends||function(){var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}}();define(["require","exports","jquery","underscore","routing","./dispatcher","./ui","./layout/bootstrap3","./layout/common","jquery-ui/ui/widgets/slider"],function(a,e,u,m,f,i,r,h,p){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DocumentManager=e.SelectionEvent=e.PluginManager=e.WidgetManager=e.BlockManager=e.RowManager=e.ContainerManager=e.ContentManager=e.BaseManager=void 0;var g={edit:!1},v={edit:!1,layout:!1,change_type:!1,move_left:!1,move_right:!1,move_up:!1,move_down:!1,add:!1,remove:!1},w={layout:!1,move_up:!1,move_down:!1,add:!1,remove:!1},b={layout:!1,move_up:!1,move_down:!1,add:!1,remove:!1},c=(l.setContentWindow=function(e){this.contentWindow=e},l.getContentWindow=function(){if(!this.contentWindow)throw"Window is not defined.";return this.contentWindow},l.setContentDocument=function(e){e=(this.$contentDocument=e).find("html").data("cms-editor-document");if(!e)throw"Undefined document data.\nDid you forget to use the cms_document_data() twig function in your template ?";this.setDocumentData(e)},l.getContentDocument=function(){if(!this.$contentDocument)throw"Document is not defined.";return this.$contentDocument},l.setDocumentData=function(e){this.documentData=e},l.getDocumentData=function(){return this.documentData},l.getDocumentLocale=function(){if(!this.documentData)throw"Content data is not defined.";return this.documentData.locale},l.clear=function(){this.contentWindow=null,this.$contentDocument=null,this.documentData=null},l.findElementById=function(e){return this.$contentDocument.find("#"+e)},l.createElement=function(e,t){if(!t)throw"Undefined parent.";return u("<div></div>").attr("id",e).appendTo(t)},l.findOrCreateElement=function(e,t){var n=this.findElementById(e);return n=0==n.length?this.createElement(e,t):n},l.setElementAttributes=function(e,t){for(var n,o=e.get(0),a=o.attributes,r=a.length;r--;)o.removeAttributeNode(a[r]);for(n in t)"data"!=n?e.removeAttr(n).attr(n,t[n]):e.removeAttr("data-cms").data("cms",t[n]);l.appendHelpers(e)},l.sortChildren=function(t,e){t.find(e).detach().get().sort(function(e,t){e=u(e).data("cms").position,t=u(t).data("cms").position;return e==t?0:t<e?1:-1}).forEach(function(e){t.append(e)})},l.generateUrl=function(e,t){return f.generate(e,m.extend({},{_document_locale:l.getDocumentLocale()},t||{}))},l.request=function(e){i.default.trigger("editor.set_busy"),(e=m.extend({},e,{method:"POST"})).data=m.extend({},e.data,{cms_viewport_width:l.getContentWindow().innerWidth});e=u.ajax(e);return e.done(function(e){l.parse(e)}),e.fail(function(e,t,n){console.log("Editor request failed.")}),e.always(function(){i.default.trigger("editor.unset_busy")}),e},l.parse=function(e){var t;e.hasOwnProperty("error")?alert(e.error):(e.hasOwnProperty("removed")&&e.removed.forEach(function(e){l.findElementById(e).remove()}),e.hasOwnProperty("content")?y.parse(e.content):e.hasOwnProperty("containers")?k.parse(e.containers):e.hasOwnProperty("rows")?C.parse(e.rows):e.hasOwnProperty("blocks")?P.parse(e.blocks):e.hasOwnProperty("widgets")&&E.parse(e.widgets),t=new H,e.hasOwnProperty("created")&&(t.$element=l.findElementById(e.created)),i.default.trigger("base_manager.response_parsed",t))},l.appendHelpers=function(e){null!=(e=null!=e&&0!=e.length||null==this.$contentDocument?e:this.$contentDocument.find(".cms-block, .cms-row, .cms-container"))&&0!=e.length&&e.filter(".cms-block, .cms-row, .cms-container").each(function(e,t){t=u(t);0==t.find("i.cms-helper").length&&t.prepend('<i class="cms-helper"></i>')})},l);function l(){}e.BaseManager=c;_.parse=function(e){if(!e.hasOwnProperty("attributes"))throw"Unexpected content data";var t=c.findElementById(e.attributes.id);if(0==t.length)throw"Content not found.";c.setElementAttributes(t,e.attributes),e.hasOwnProperty("containers")&&k.parse(e.containers,t),c.sortChildren(t,"> .cms-container")},_.generateUrl=function(e,t,n){e=e.data("cms").id;if(!e)throw"Invalid id";return c.generateUrl(t,m.extend({},{contentId:e},n||{}))},_.request=function(e,t,n,o){return(o=o||{}).url=this.generateUrl(e,t,n),c.request(o)};var y=_;function _(){}e.ContentManager=y;n.parse=function(r,i){r.forEach(function(n,e){if(!n.hasOwnProperty("attributes"))throw"Unexpected container data";var t=c.findOrCreateElement(n.attributes.id,i),o=(c.setElementAttributes(t,n.attributes),t.find("> .cms-inner-container")),a=n.hasOwnProperty("content")?n.content:null,a=(a&&0<a.length&&(o.detach(),t.html(a).append(o)),n.hasOwnProperty("innerAttributes")&&(o.each(function(e,t){u(t).attr("id")!==n.innerAttributes.id&&u(t).remove()}),o=c.findOrCreateElement(n.innerAttributes.id,t),c.setElementAttributes(o,n.innerAttributes)),n.hasOwnProperty("innerContent")?n.innerContent:null);a&&0<a.length?o.html(a):(o.children().not(".cms-row").remove(),n.hasOwnProperty("rows")&&C.parse(n.rows,o),c.sortChildren(o,"> .cms-row"),i||e!=r.length-1||c.sortChildren(t.closest(".cms-content"),"> .cms-container"))})},n.generateUrl=function(e,t,n){e=e.data("cms").id;if(!e)throw"Invalid id";return c.generateUrl(t,m.extend({},{containerId:e},n||{}))},n.request=function(e,t,n,o){return(o=o||{}).url=this.generateUrl(e,t,n),c.request(o)},n.edit=function(e){B.createContainerPlugin(e.data("cms").type,e)},n.changeType=function(e,t){n.request(e,"admin_ekyna_cms_editor_container_change_type",null,{data:{type:t}})},n.remove=function(e){n.request(e,"admin_ekyna_cms_editor_container_remove")},n.add=function(e,t){e=e.closest(".cms-content");if(1!=e.length)throw"Container content not found.";y.request(e,"admin_ekyna_cms_editor_content_create_container",null,{data:{type:t}})},n.moveUp=function(e){n.request(e,"admin_ekyna_cms_editor_container_move_up")},n.moveDown=function(e){n.request(e,"admin_ekyna_cms_editor_container_move_down")};var k=n;function n(){}e.ContainerManager=k;$.parse=function(o,a){o.forEach(function(e,t){if(!e.hasOwnProperty("attributes"))throw"Unexpected row data";var n=c.findOrCreateElement(e.attributes.id,a);c.setElementAttributes(n,e.attributes),e.hasOwnProperty("blocks")&&P.parse(e.blocks,n),c.sortChildren(n,"> .cms-block"),a||t!=o.length-1||c.sortChildren(n.closest(".cms-inner-container"),"> .cms-row")})},$.generateUrl=function(e,t,n){e=e.data("cms").id;if(!e)throw"Invalid id";return c.generateUrl(t,m.extend({},{rowId:e},n||{}))},$.request=function(e,t,n,o){return(o=o||{}).url=this.generateUrl(e,t,n),c.request(o)},$.remove=function(e){$.request(e,"admin_ekyna_cms_editor_row_remove")},$.add=function(e){e=e.closest(".cms-container");if(1!=e.length)throw"Row container not found.";k.request(e,"admin_ekyna_cms_editor_container_create_row")},$.moveUp=function(e){$.request(e,"admin_ekyna_cms_editor_row_move_up")},$.moveDown=function(e){$.request(e,"admin_ekyna_cms_editor_row_move_down")};var C=$;function $(){}e.RowManager=C;o.parse=function(o,a){o.forEach(function(e,t){if(!e.hasOwnProperty("attributes"))throw"Unexpected block data";var n=c.findOrCreateElement(e.attributes.id,a);c.setElementAttributes(n,e.attributes),e.hasOwnProperty("widgets")&&E.parse(e.widgets,n),c.sortChildren(n,"> .cms-widget"),a||t!=o.length-1||c.sortChildren(n.closest(".cms-row"),"> .cms-block")})},o.generateUrl=function(e,t,n){e=e.data("cms");if(!e.id)throw"Invalid id";return c.generateUrl(t,m.extend({},{blockId:e.id,widgetType:e.type},n||{}))},o.request=function(e,t,n,o){return(o=o||{}).url=this.generateUrl(e,t,n),c.request(o)},o.edit=function(e){B.createBlockPlugin(e.data("cms").type,e)},o.changeType=function(e,t){o.request(e,"admin_ekyna_cms_editor_block_change_type",null,{data:{type:t}})},o.remove=function(e){o.request(e,"admin_ekyna_cms_editor_block_remove")},o.add=function(e,t){e=e.closest(".cms-row");if(1!=e.length)throw"Block row not found.";C.request(e,"admin_ekyna_cms_editor_row_create_block",null,{data:{type:t}})},o.moveUp=function(e){o.request(e,"admin_ekyna_cms_editor_block_move_up")},o.moveDown=function(e){o.request(e,"admin_ekyna_cms_editor_block_move_down")},o.moveLeft=function(e){o.request(e,"admin_ekyna_cms_editor_block_move_left")},o.moveRight=function(e){o.request(e,"admin_ekyna_cms_editor_block_move_right")};var P=o;function o(){}e.BlockManager=P;D.parse=function(o,a){o.forEach(function(e,t){if(!e.hasOwnProperty("attributes"))throw"Unexpected block data";var n=c.findOrCreateElement(e.attributes.id,a);c.setElementAttributes(n,e.attributes),e.hasOwnProperty("content")&&n.html(e.content),a||t!=o.length-1||c.sortChildren(n.closest(".cms-block"),"> .cms-widget")})};var E=D;function D(){}e.WidgetManager=E;O.setUp=function(e,t){this.$element=e,this.data={};var n=new H,o=(n.$element=e,n.origin={top:t.clientY,left:t.clientX},d.createLayoutToolbar(n),d.getToolbar()),a=c.getContentWindow().innerWidth;this.adapters=[new p.CommonAdapter(this.data,this.$element),new h.Bootstrap3Adapter(this.data,this.$element)],this.adapters.forEach(function(e){e.initialize(),e.onResize(a,o)}),this.backup=JSON.parse(JSON.stringify(this.data)),i.default.on("viewport.resize",O.onResizeHandler)},O.tearDown=function(){i.default.off("viewport.resize",O.onResizeHandler),this.data=null,this.backup=null,this.$element=null,this.adapters=[]},O.hasChanges=function(){return this.data!=this.backup},O.setData=function(t,n){this.adapters.forEach(function(e){e.setData(t,n)}),this.apply()},O.apply=function(){var t=this;this.adapters.forEach(function(e){e.apply(t.data)})},O.submit=function(){var e=this;if(this.hasChanges()){i.default.trigger("editor.set_busy");var t,n=null,o={},a={"cms-container":"container","cms-row":"row","cms-block":"block"};for(t in a)if(this.$element.hasClass(t)){n="admin_ekyna_cms_editor_"+a[t]+"_layout",o[a[t]+"Id"]=this.$element.data("cms").id;break}if(null===n)throw"Unexpected element type.";var r=c.request({url:f.generate(n,o),data:{data:this.data}});r.done(function(){e.tearDown(),d.clearToolbar()}),r.fail(function(){e.cancel()}),r.always(function(){i.default.trigger("editor.unset_busy")})}else this.cancel()},O.cancel=function(){var t=this;this.adapters.forEach(function(e){e.apply(t.backup)}),O.tearDown(),d.clearToolbar()},O.onResizeHandler=function(t){var n=d.getToolbar();if("layout"!=n.model.getName())throw"Unexpected toolbar";O.adapters.forEach(function(e){e.onResize(t.size.width,n)}),n.render()};var T=O;function O(){}i.default.on("toolbar.remove",function(e){"layout"==e.toolbar.getName()&&T.hasChanges()&&(confirm("Souhaitez-vous appliquer les changements ?")?T.submit():T.cancel())}),i.default.on("layout.change",function(e){T.setData(e.getName(),e.getValue())}),i.default.on("layout.submit",function(){return T.submit()}),i.default.on("layout.cancel",function(){return T.cancel()}),i.default.on("block.edit",function(e){return P.edit(e.get("data").$block)}),i.default.on("block.layout",function(e,t){return T.setUp(e.get("data").$block,t)}),i.default.on("block.change-type",function(e,t){return P.changeType(e.get("data").$block,t.data.type)}),i.default.on("block.move-up",function(e){return P.moveUp(e.get("data").$block)}),i.default.on("block.move-down",function(e){return P.moveDown(e.get("data").$block)}),i.default.on("block.move-left",function(e){return P.moveLeft(e.get("data").$block)}),i.default.on("block.move-right",function(e){return P.moveRight(e.get("data").$block)}),i.default.on("block.remove",function(e){return P.remove(e.get("data").$block)}),i.default.on("block.add",function(e,t){return P.add(e.get("data").$block,t.data.type)}),i.default.on("row.layout",function(e,t){return T.setUp(e.get("data").$row,t)}),i.default.on("row.move-up",function(e){return C.moveUp(e.get("data").$row)}),i.default.on("row.move-down",function(e){return C.moveDown(e.get("data").$row)}),i.default.on("row.remove",function(e){return C.remove(e.get("data").$row)}),i.default.on("row.add",function(e){return C.add(e.get("data").$row)}),i.default.on("container.edit",function(e){return k.edit(e.get("data").$container)}),i.default.on("container.layout",function(e,t){return T.setUp(e.get("data").$container,t)}),i.default.on("container.change-type",function(e,t){return k.changeType(e.get("data").$container,t.data.type)}),i.default.on("container.move-up",function(e){return k.moveUp(e.get("data").$container)}),i.default.on("container.move-down",function(e){return k.moveDown(e.get("data").$container)}),i.default.on("container.remove",function(e){return k.remove(e.get("data").$container)}),i.default.on("container.add",function(e,t){return k.add(e.get("data").$container,t.data.type)});U.load=function(e){this.registry=e},U.getActivePlugin=function(){if(!this.hasActivePlugin())throw"Active plugin is not set";return this.activePlugin},U.hasActivePlugin=function(){return!!this.activePlugin},U.clearActivePlugin=function(){var e=this;return this.hasActivePlugin()?this.activePlugin.destroy().then(function(){e.activePlugin=null}):Promise.resolve()},U.createPlugin=function(e,t,n){var o=this;this.clearActivePlugin().then(function(){e.forEach(function(e){e.name===t&&a([e.path],function(e){o.activePlugin=new e(n,c.getContentWindow()),o.activePlugin.edit()})})})},U.createBlockPlugin=function(e,t){this.createPlugin(this.getBlockPluginsConfig(),e,t)},U.createContainerPlugin=function(e,t){this.createPlugin(this.getContainerPluginsConfig(),e,t)},U.getBlockPluginsConfig=function(){if(!this.registry)throw"Plugins registry is not configured";return this.registry.block},U.getContainerPluginsConfig=function(){if(!this.registry)throw"Plugins registry is not configured";return this.registry.container};var B=U;function U(){}e.PluginManager=B;M.prototype.preventDefault=function(){this.defaultPrevented=!0},M.prototype.isDefaultPrevented=function(){return this.defaultPrevented};var A=M;function M(){this.defaultPrevented=!1}__extends(I,q=A);var q,x=I;function I(){return null!==q&&q.apply(this,arguments)||this}s.getToolbar=function(){if(!s.hasToolbar())throw"Toolbar is not set";return s.toolbar},s.hasToolbar=function(){return null!=s.toolbar},s.clearToolbar=function(){if(s.hasToolbar()){var e=new x;if(e.toolbar=s.toolbar.model,i.default.trigger("toolbar.remove",e),e.isDefaultPrevented())return!1;s.toolbar.remove(),s.toolbar=null}return!0},s.createToolbar=function(e){s.clearToolbar()&&(s.toolbar=new r.ToolbarView({model:e}),u(document).find("body").append(this.toolbar.$el),s.toolbar.render())},s.createWidgetToolbar=function(e){var t=e.$element,e=new r.Toolbar({name:"widget",classes:["vertical","widget-toolbar"],origin:e.origin}),n=m.extend(g,t.data("cms").actions);e.addControl("default",new r.Button({name:"edit",title:"Edit",icon:"content",disabled:!n.edit,event:"block.edit",data:{$block:t}})),s.createToolbar(e)},s.createBlockToolbar=function(e){var t=e.$element,n=t.closest(".cms-row"),e=new r.Toolbar({name:"block",classes:["vertical","block-toolbar"],origin:e.origin}),o=m.extend(v,t.data("cms").actions),a=(o.edit&&e.addControl("default",new r.Button({name:"edit",title:"Edit",icon:"content",event:"block.edit",data:{$block:t}})),e.addControl("default",new r.Button({name:"layout",title:"Layout",icon:"layout",disabled:!o.layout,event:"block.layout",data:{$block:t}})),[]);B.getBlockPluginsConfig().forEach(function(e){a.push({name:e.name,title:e.title,confirm:"Êtes-vous sûr de vouloir changer le type de ce bloc ? (Le contenu actuel sera définitivement perdu).",data:{type:e.name}})}),e.addControl("default",new r.Button({name:"change-type",title:"Change type",icon:"change-type",disabled:!o.change_type&&1<a.length,event:"block.change-type",data:{$block:t},choices:a})),1==n.length&&(e.addControl("vertical",new r.Button({name:"move-up",title:"Move up",icon:"move-up",disabled:!o.move_up,event:"block.move-up",data:{$block:t}})),e.addControl("vertical",new r.Button({name:"move-down",title:"Move down",icon:"move-down",disabled:!o.move_down,event:"block.move-down",data:{$block:t}})),e.addControl("horizontal",new r.Button({name:"move-left",title:"Move left",icon:"move-left",disabled:!o.move_left,event:"block.move-left",data:{$block:t}})),e.addControl("horizontal",new r.Button({name:"move-right",title:"Move right",icon:"move-right",disabled:!o.move_right,event:"block.move-right",data:{$block:t}})),e.addControl("add",new r.Button({name:"remove",title:"Remove",icon:"remove-block",disabled:!o.remove,confirm:"Êtes-vous sûr de vouloir supprimer ce bloc ?",event:"block.remove",data:{$block:t}})),a=[],B.getBlockPluginsConfig().forEach(function(e){a.push({name:e.name,title:e.title,data:{type:e.name}})}),e.addControl("add",new r.Button({name:"add",title:"Create a new block after this one",icon:"add-block",disabled:!o.add,event:"block.add",data:{$block:t},choices:a}))),s.createToolbar(e)},s.createRowToolbar=function(e){var t=e.$element,n=t.closest(".cms-inner-container"),e=new r.Toolbar({name:"row",classes:["vertical","row-toolbar"],origin:e.origin}),o=m.extend(w,t.data("cms").actions);e.addControl("default",new r.Button({name:"layout",title:"Layout",icon:"layout",disabled:!o.layout,event:"row.layout",data:{$row:t}})),0<n.length&&(e.addControl("move",new r.Button({name:"move-up",title:"Move up",icon:"move-up",disabled:!o.move_up,event:"row.move-up",data:{$row:t}})),e.addControl("move",new r.Button({name:"move-down",title:"Move down",icon:"move-down",disabled:!o.move_down,event:"row.move-down",data:{$row:t}})),e.addControl("default",new r.Button({name:"remove",title:"Remove",icon:"remove-row",disabled:!o.remove,confirm:"Êtes-vous sûr de vouloir supprimer cette ligne ?",event:"row.remove",data:{$row:t}})),e.addControl("default",new r.Button({name:"add",title:"Create a new row",icon:"add-row",disabled:!o.add,event:"row.add",data:{$row:t}}))),s.createToolbar(e)},s.createContainerToolbar=function(e){var t=e.$element,n=t.closest(".cms-content"),e=new r.Toolbar({name:"container",classes:["vertical","container-toolbar"],origin:e.origin}),o=m.extend(b,t.data("cms").actions),a=(e.addControl("default",new r.Button({name:"edit",title:"Edit",icon:"content",disabled:!o.edit,event:"container.edit",data:{$container:t}})),e.addControl("default",new r.Button({name:"layout",title:"Layout",icon:"layout",disabled:!o.layout,event:"container.layout",data:{$container:t}})),[]);B.getContainerPluginsConfig().forEach(function(e){a.push({name:e.name,title:e.title,confirm:"Êtes-vous sûr de vouloir changer le type de ce contener ? (Le contenu actuel sera définitivement perdu).",data:{type:e.name}})}),e.addControl("default",new r.Button({name:"change-type",title:"Change type",icon:"change-type",disabled:!o.change_type&&1<a.length,event:"container.change-type",data:{$container:t},choices:a})),1==n.length&&(e.addControl("move",new r.Button({name:"move-up",title:"Move up",icon:"move-up",disabled:!o.move_up,event:"container.move-up",data:{$container:t}})),e.addControl("move",new r.Button({name:"move-down",title:"Move down",icon:"move-down",disabled:!o.move_down,event:"container.move-down",data:{$container:t}})),e.addControl("add",new r.Button({name:"remove",title:"Remove",icon:"remove-container",disabled:!o.remove,confirm:"Êtes-vous sûr de vouloir supprimer ce conteneur ?",event:"container.remove",data:{$container:t}})),a=[],B.getContainerPluginsConfig().forEach(function(e){a.push({name:e.name,title:e.title,data:{type:e.name}})}),e.addControl("add",new r.Button({name:"add",title:"Create a new container after this one",icon:"add-container",disabled:!o.add,event:"container.add",data:{$container:t},choices:a}))),s.createToolbar(e)},s.createLayoutToolbar=function(e){var t=e.$element,e=new r.Toolbar({name:"layout",classes:["vertical","layout-toolbar"],origin:e.origin});t.hasClass("cms-block")&&(e.addControl("default",new r.Slider({name:"size",title:"Size",event:"layout.change",min:1,max:12})),e.addControl("default",new r.Slider({name:"offset",title:"Offset",event:"layout.change",min:0,max:11}))),e.addControl("default",new r.Slider({name:"padding_top",title:"Padding top",event:"layout.change",min:0,max:300})),e.addControl("default",new r.Slider({name:"padding_bottom",title:"Padding bottom",event:"layout.change",min:0,max:300})),e.addControl("footer",new r.Button({name:"submit",title:"Ok",theme:"primary",icon:"ok",event:"layout.submit"})),e.addControl("footer",new r.Button({name:"cancel",title:"Cancel",icon:"cancel",event:"layout.cancel"})),s.createToolbar(e)},s.toolbar=null;var d=s;function s(){}__extends(R,z=A);var z,H=R;function R(){return null!==z&&z.apply(this,arguments)||this}function t(e){var n=this;this.enabled=!1,this.clickEvent=null,this.config=e,this.viewportOrigin={top:50,left:0},this.viewportSize={width:0,height:0},this.selectionOffset={top:0,left:0},this.selectionId=null,this.documentMouseDownHandler=function(e){return n.onDocumentMouseDown(e)},this.documentMouseUpHandler=function(){return n.onDocumentMouseUp()},this.documentSelectHandler=function(e){return n.select(e)},this.powerClickHandler=function(e){return n.onPowerClick(e)},this.viewportLoadHandler=function(e,t){return n.onViewportLoad(e,t)},this.viewportUnloadHandler=function(e){return n.onViewportUnload(e)},this.viewportResizeHandler=function(e){return n.onViewportResize(e)}}e.SelectionEvent=H,t.prototype.initialize=function(){var t=this;i.default.on("viewport.resize",this.viewportResizeHandler),i.default.on("document_manager.select",this.documentSelectHandler),i.default.on("base_manager.response_parsed",function(e){!e.$element&&t.selectionId&&(e.$element=c.findElementById(t.selectionId)),t.deselect().then(function(){t.select(e)}),t.tweakAnchorsAndForms()}),i.default.on("block.edit",function(){return d.clearToolbar()})},t.prototype.onPowerClick=function(e){e=e.get("active");e&&!this.enabled?(this.enabled=!0,this.enableEdition()):this.enabled&&!e?(this.enabled=!1,this.disableEdition()):this.enabled=e},t.prototype.onViewportLoad=function(e,t){t=u(t);return c.setContentWindow(e),c.setContentDocument(t),this.tweakAnchorsAndForms(),this.enabled&&this.enableEdition(),i.default.trigger("document_manager.document_data",c.getDocumentData()),this},t.prototype.tweakAnchorsAndForms=function(){var a=this,e=c.getContentDocument();e.off("click","a[href]").on("click","a[href]",function(e){e.preventDefault(),e.stopPropagation();e=e.currentTarget;return e.hostname!==a.config.hostname?console.log("Attempt to navigate out of the website has been blocked."):a.enabled||i.default.trigger("document_manager.navigate",e.href),!1}),e.find("form").each(function(e,t){var t=u(t),n=t.attr("action"),o=document.createElement("a");o.href=n,o.hostname!==a.config.hostname?t.off("submit").on("submit",function(e){return console.log("Attempt to navigate out of the website has been blocked."),e.preventDefault(),!1}):t.attr("action",r.Util.addEditorParameterToUrl(n))})},t.prototype.onViewportUnload=function(e){if(!e.defaultPrevented)return B.hasActivePlugin()?(e.preventDefault(),B.getActivePlugin().isUpdated()?e.returnValue="Vos changements n'ont pas été sauvegardés !":this.deselect().then(function(){i.default.trigger("document_manager.reload")}),this):(c.clear(),d.clearToolbar()||e.preventDefault(),this)},t.prototype.onViewportResize=function(e){return this.viewportOrigin=e.origin,this.viewportSize=e.size,d.hasToolbar()&&d.getToolbar().applyOriginOffset(e.origin),this},t.prototype.onDocumentMouseDown=function(e){this.clickEvent=null;var t=u(e.target);0<t.closest("#editor-document-toolbar").length||B.hasActivePlugin()&&B.getActivePlugin().preventDocumentSelection(t)||(this.clickEvent=new H,this.clickEvent.origin={top:e.clientY,left:e.clientX},1==(e=t.closest(".cms-widget, .cms-block, .cms-row, .cms-container")).length&&this.selectionId!=e.attr("id")&&(this.clickEvent.$element=e,this.clickEvent.$target=t))},t.prototype.onDocumentMouseUp=function(){var e=this;this.clickEvent&&this.deselect().then(function(){e.clickEvent.$element?e.select(e.clickEvent):e.createToolbar(e.clickEvent),e.clickEvent=null})},t.prototype.deselect=function(){var e=this;return B.clearActivePlugin().then(function(){if(!d.clearToolbar())return Promise.reject("Layout has changes.");e.selectionId&&(c.findElementById(e.selectionId).removeClass("selected"),e.selectionId=null)})},t.prototype.select=function(e){e.$element&&1==e.$element.length&&(this.selectionId=e.$element.addClass("selected").attr("id"),this.createToolbar(e))},t.prototype.createToolbar=function(e){if(!e.$element){var t=c.findElementById(this.selectionId);if(1!=t.length)return;e.$element=t}if(e.origin?this.selectionOffset={top:e.origin.top-e.$element.offset().top,left:e.origin.left-e.$element.offset().left}:e.origin={top:e.$element.offset().top+this.selectionOffset.top,left:e.$element.offset().left+this.selectionOffset.left},e.$element.hasClass("cms-widget"))d.createWidgetToolbar(e);else if(e.$element.hasClass("cms-block"))d.createBlockToolbar(e);else if(e.$element.hasClass("cms-row"))d.createRowToolbar(e);else{if(!e.$element.hasClass("cms-container"))throw"Unexpected element";d.createContainerToolbar(e)}d.getToolbar().applyOriginOffset(this.viewportOrigin)},t.prototype.enableEdition=function(){var e,t=c.getContentDocument();if(this.enabled&&null!==t)return 0===t.find("link#cms-editor-stylesheet").length&&((e=document.createElement("link")).id="cms-editor-stylesheet",e.href=document.documentElement.getAttribute("data-asset-base-url")+this.config.css_path,e.media="screen",e.rel="stylesheet",e.type="text/css",t.find("head").append(e)),c.appendHelpers(),t.on("mousedown",this.documentMouseDownHandler),t.on("mouseup",this.documentMouseUpHandler),this},t.prototype.disableEdition=function(){var e,t=c.getContentDocument();if(!this.enabled&&null!==t)return this.deselect(),t.off("mousedown",this.documentMouseDownHandler),t.off("mouseup",this.documentMouseUpHandler),e=t.find("link#cms-editor-stylesheet"),e.length&&e.remove(),t.find("i.cms-helper").remove(),this},e.DocumentManager=t});