var __extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();define(["require","exports","../../dispatcher","../base-plugin","../../document-manager"],function(t,e,r,n,i){"use strict";r.default.on("viewport_iframe.unload",function(){c.clear()});o=n.BasePlugin,__extends(a,o),a.clear=function(){a.initPromise=null,a.config=null,a.externalPlugins=null,a.tinymce=null},a.prototype.edit=function(){var t=this;o.prototype.edit.call(this),this.initialize().then(function(){if(t.destroyed)return Promise.resolve();t.createEditor()})},a.prototype.save=function(){var n=this;return this.isUpdated()?this.initialize().then(function(){r.default.trigger("editor.set_busy");var t=a.tinymce.get("tinymce-plugin-editor");if(!t)throw"Failed to get tinymce editor instance.";var e=t.getContent();return i.BlockManager.request(n.$element,"admin_ekyna_cms_editor_block_edit",null,{data:{data:{content:e}}}).then(function(){n.$element.html(e),n.updated=!1,r.default.trigger("editor.unset_busy")})}):Promise.resolve()},a.prototype.destroy=function(){var e=this;return this.save().then(function(){var t=a.tinymce.get("tinymce-plugin-editor"),t=(t&&t.remove(),e.$element.find("#tinymce-plugin-editor"));return t.length&&t.children().first().unwrap(),o.prototype.destroy.call(e)})},a.prototype.preventDocumentSelection=function(t){return 0<t.closest("#tinymce-plugin-editor, .mce-container, .mce-widget, .mce-reset, .mce-tooltip").length},a.prototype.initialize=function(){var o=this;return a.initPromise||(r.default.trigger("editor.set_busy"),a.initPromise=new Promise(function(i){if(a.tinymce&&i(),!o.window.hasOwnProperty("require")||"function"!=typeof o.window.require)throw"requireJs is not available the content window.";o.window.require(["json!tinymce_config","tinymce"],function(t){if(void 0===o.window.tinymce)throw"Failed to load tinymce from the content iFrame.";if(a.config=t,(a.tinymce=o.window.tinymce).baseURL=a.config.tinymce_url,a.tinymce.suffix=".min",a.externalPlugins=[],"object"==typeof a.config.external_plugins)for(var e in a.config.external_plugins){var n;a.config.external_plugins.hasOwnProperty(e)&&((n=a.config.external_plugins[e].url||null)&&(a.externalPlugins.push({id:e,url:n}),a.tinymce.PluginManager.load(e,n)))}r.default.trigger("editor.unset_busy"),i()})})),a.initPromise},a.prototype.createEditor=function(){var e=this,t=(0==this.$element.find("#tinymce-plugin-editor").length&&this.$element.wrapInner('<div id="tinymce-plugin-editor"></div>'),a.config.theme.advanced);t.external_plugins=t.external_plugins||{};for(var n=0;n<a.externalPlugins.length;n++)t.external_plugins[a.externalPlugins[n].id]=a.externalPlugins[n].url;t.add_unload_trigger=!1,t.inline=!0,t.menubar=!1,t.entity_encoding="raw",t.toolbar_items_size="small",t.paste_as_text=!0,t.relative_urls=!1,t.content_css=[],t.setup=function(n){if("object"==typeof a.config.tinymce_buttons)for(var t in a.config.tinymce_buttons)a.config.tinymce_buttons.hasOwnProperty(t)&&!function(e,t){t.onclick=function(){var t=this.window["tinymce_button_"+e];"function"==typeof t?t(n):alert('You have to create callback function: "tinymce_button_'+e+'"')},n.addButton(e,t)}(t,clone(a.config.tinymce_buttons[t]));n.on("click",function(t){t.stopPropagation()}),n.on("init",function(){var t;a.config.use_callback_tinymce_init&&("function"==typeof(t=e.window.callback_tinymce_init)?t(n):alert("You have to create callback function: callback_tinymce_init")),n.focus()}),n.on("change",function(){e.setUpdated(!0)})};var i=new a.tinymce.Editor("tinymce-plugin-editor",t,a.tinymce.EditorManager);i.render(),i.show()};var o,c=a;function a(){return null!==o&&o.apply(this,arguments)||this}return c});