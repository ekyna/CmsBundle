define(["require","exports","jquery","routing","ekyna-modal","./dispatcher","./controls","./viewport","./document-manager"],function(a,b,c,d,e,f,g,h,i){"use strict";var j=function(){function a(){var a=this;this.onLocaleSelectChangeHandler=function(b){return a.onLocaleSelectChange(b)},this.onPageSelectChangeHandler=function(b){return a.onPageSelectChange(b)},this.onDocumentDataHandler=function(b){return a.onDocumentData(b)},this.onDocumentManagerReloadHandler=function(){return a.onDocumentManagerReload()},this.onNewPageClickHandler=function(b){return a.onNewPageClick(b)},this.onEditPageClickHandler=function(b){return a.onEditPageClick(b)},this.busy=!0}return a.prototype.init=function(a){this.config=a,c(document).off("ajaxError",function(a,b){403===b.status&&alert("You have been disconnected. Please proceed to login.")}),i.PluginManager.load(a.plugins),this.documentManager=new i.DocumentManager({hostname:a.hostname,css_path:a.css_path}),this.documentManager.initialize(),this.mainToolbar=new g.MainToolbarView({model:new g.MainToolbar({id:"editor-control-bar",classes:["horizontal"]},{viewports:a.viewports,locales:a.locales})}),c("[data-controls-placeholder]").replaceWith(this.mainToolbar.$el),this.mainToolbar.render(),this.viewport=new h.ViewportView({model:new h.ViewportModel}),c("[data-viewport-placeholder]").replaceWith(this.viewport.render().$el),this.$busy=c("#cms-editor-busy"),this.initHandlers(),this.viewport.initIFrame(a.path)},a.prototype.setBusy=function(a){a&&a.defaultPrevented||this.busy||(this.busy=!0,this.mainToolbar.model.getControl("default","reload").activate().startSpinning(),this.$busy.show())},a.prototype.unsetBusy=function(){this.busy&&(this.mainToolbar.model.getControl("default","reload").deactivate().stopSpinning(),this.$busy.hide(),this.busy=!1)},a.prototype.initHandlers=function(){var a=this;f["default"].on("editor.set_busy",function(){return a.setBusy()}),f["default"].on("editor.unset_busy",function(){return a.unsetBusy()}),f["default"].on("controls.power.click",this.documentManager.powerClickHandler),f["default"].on("controls.reload.click",this.viewport.onControlsReloadClickHandler),f["default"].on("controls.viewport.click",this.viewport.onControlsViewportClickHandler),f["default"].on("controls.locale.change",this.onLocaleSelectChangeHandler),f["default"].on("controls.page.change",this.onPageSelectChangeHandler),f["default"].on("controls.new_page.click",this.onNewPageClickHandler),f["default"].on("controls.edit_page.click",this.onEditPageClickHandler),f["default"].on("viewport_iframe.unload",this.documentManager.viewportUnloadHandler),f["default"].on("viewport_iframe.unload",function(b){return a.setBusy(b)}),f["default"].on("viewport_iframe.load",this.documentManager.viewportLoadHandler),f["default"].on("viewport_iframe.load",function(){return a.unsetBusy()}),f["default"].on("document_manager.reload",this.onDocumentManagerReloadHandler),f["default"].on("document_manager.navigate",this.viewport.onDocumentManagerNavigateHandler),f["default"].on("document_manager.document_data",this.onDocumentDataHandler),f["default"].on("ui.control.render",function(){a.mainToolbar.postRender()})},a.prototype.loadPagesList=function(a){var b=this.mainToolbar.getPageSelect(),e=c.ajax({url:d.generate("ekyna_cms_editor_pages_list",{document_locale:a}),method:"GET",dataType:"json"});return e.done(function(a){b.setChoices(a)}),e.fail(function(){throw"Failed to load page list."}),e},a.prototype.onLocaleSelectChange=function(a){var b=this,c=this.mainToolbar.getPageSelect(),d=c.getActiveChoice().value;this.loadPagesList(a.getActiveChoice().value).then(function(){return b.updateDocumentControls(d)})},a.prototype.onPageSelectChange=function(a){this.viewport.load(a.getActiveChoice().data.path)},a.prototype.onDocumentData=function(a){var b=this,c=this.mainToolbar.getLocaleSelect(),d=this.mainToolbar.getPageSelect(),e=c.get("value");c.select(a.locale),a.locale!=e||0==d.get("choices").length?this.loadPagesList(a.locale).then(function(){return b.updateDocumentControls(a.id,!1)}):a.id&&this.updateDocumentControls(a.id,!1)},a.prototype.onDocumentManagerReload=function(){this.viewport.reload()},a.prototype.onNewPageClick=function(a){var b=this,f=new e,g=this.mainToolbar.getPageSelect().getValue();f.load({url:d.generate("ekyna_cms_page_admin_new_child",{pageId:g}),method:"GET"}),c(f).on("ekyna.modal.response",function(a){if("json"==a.contentType){a.preventDefault();var c=a.content;b.loadPagesList(b.mainToolbar.getLocaleSelect().getValue()).then(function(){return b.updateDocumentControls(c.id)}),a.modal.close()}})},a.prototype.onEditPageClick=function(a){var b=this,f=new e,g=this.mainToolbar.getPageSelect().getValue();f.load({url:d.generate("ekyna_cms_page_admin_edit",{pageId:g}),method:"GET"}),c(f).on("ekyna.modal.response",function(a){if("json"==a.contentType){a.preventDefault();var c=a.content;b.loadPagesList(b.mainToolbar.getLocaleSelect().getValue()).then(function(){return b.updateDocumentControls(c.id)}),a.modal.close()}})},a.prototype.updateDocumentControls=function(a,b){void 0===b&&(b=!0);var c=this.mainToolbar.getNewPageButton(),d=this.mainToolbar.getEditPageButton(),e=this.mainToolbar.getPageSelect(),f=null;c.disable(),d.disable();try{e.select(a),f=e.getActiveChoice()}catch(g){}return f?(d.enable(),f.data.locked||c.enable(),b&&this.viewport.load(f.data.path)):(c.disable(),d.disable()),f},a}();return j});