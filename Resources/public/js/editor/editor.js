define(["require","exports","jquery","routing","ekyna-modal","./dispatcher","./controls","./viewport","./document-manager"],function(e,s,a,i,l,o,t,n,r){"use strict";function c(){var t=this;this.onLocaleSelectChangeHandler=function(e){return t.onLocaleSelectChange(e)},this.onPageSelectChangeHandler=function(e){return t.onPageSelectChange(e)},this.onDocumentDataHandler=function(e){return t.onDocumentData(e)},this.onDocumentManagerReloadHandler=function(){return t.onDocumentManagerReload()},this.onNewPageClickHandler=function(e){return t.onNewPageClick(e)},this.onEditPageClickHandler=function(e){return t.onEditPageClick(e)},this.busy=!0}return c.prototype.init=function(e){this.config=e,a(document).ajaxError(function(e){403===e.status&&alert("You have been disconnected. Please proceed to login.")}),r.PluginManager.load(e.plugins),this.documentManager=new r.DocumentManager({hostname:e.hostname,css_path:e.css_path}),this.documentManager.initialize(),this.mainToolbar=new t.MainToolbarView({model:new t.MainToolbar({id:"editor-control-bar",classes:["horizontal"]},{viewports:e.viewports,locales:e.locales})}),a("[data-controls-placeholder]").replaceWith(this.mainToolbar.$el),this.mainToolbar.render(),this.viewport=new n.ViewportView({model:new n.ViewportModel}),a("[data-viewport-placeholder]").replaceWith(this.viewport.render().$el),this.$busy=a("#cms-editor-busy"),this.initHandlers(),this.viewport.initIFrame(e.path)},c.prototype.setBusy=function(e){e&&e.defaultPrevented||this.busy||(this.busy=!0,this.mainToolbar.model.getControl("default","reload").activate().startSpinning(),this.$busy.show())},c.prototype.unsetBusy=function(){this.busy&&(this.mainToolbar.model.getControl("default","reload").deactivate().stopSpinning(),this.$busy.hide(),this.busy=!1)},c.prototype.initHandlers=function(){var t=this;o.default.on("editor.set_busy",function(){return t.setBusy()}),o.default.on("editor.unset_busy",function(){return t.unsetBusy()}),o.default.on("controls.power.click",this.documentManager.powerClickHandler),o.default.on("controls.reload.click",this.viewport.onControlsReloadClickHandler),o.default.on("controls.viewport.click",this.viewport.onControlsViewportClickHandler),o.default.on("controls.locale.change",this.onLocaleSelectChangeHandler),o.default.on("controls.page.change",this.onPageSelectChangeHandler),o.default.on("controls.new_page.click",this.onNewPageClickHandler),o.default.on("controls.edit_page.click",this.onEditPageClickHandler),o.default.on("viewport_iframe.unload",this.documentManager.viewportUnloadHandler),o.default.on("viewport_iframe.unload",function(e){return t.setBusy(e)}),o.default.on("viewport_iframe.load",this.documentManager.viewportLoadHandler),o.default.on("viewport_iframe.load",function(){return t.unsetBusy()}),o.default.on("document_manager.reload",this.onDocumentManagerReloadHandler),o.default.on("document_manager.navigate",this.viewport.onDocumentManagerNavigateHandler),o.default.on("document_manager.document_data",this.onDocumentDataHandler),o.default.on("ui.control.render",function(){t.mainToolbar.postRender()})},c.prototype.loadPagesList=function(e){var t=this.mainToolbar.getPageSelect(),e=a.ajax({url:i.generate("admin_ekyna_cms_editor_pages_list",{document_locale:e}),method:"GET",dataType:"json"});return e.done(function(e){t.setChoices(e)}),e.fail(function(){throw"Failed to load page list."}),e},c.prototype.onLocaleSelectChange=function(e){var t=this,o=this.mainToolbar.getPageSelect().getActiveChoice().value;this.loadPagesList(e.getActiveChoice().value).then(function(){return t.updateDocumentControls(o)})},c.prototype.onPageSelectChange=function(e){this.viewport.load(e.getActiveChoice().data.path)},c.prototype.onDocumentData=function(e){var t=this,o=this.mainToolbar.getLocaleSelect(),n=this.mainToolbar.getPageSelect(),a=o.get("value");o.select(e.locale),e.locale!=a||0==n.get("choices").length?this.loadPagesList(e.locale).then(function(){return t.updateDocumentControls(e.id,!1)}):e.id&&this.updateDocumentControls(e.id,!1)},c.prototype.onDocumentManagerReload=function(){this.viewport.reload()},c.prototype.onNewPageClick=function(e){var o=this,t=new l,n=this.mainToolbar.getPageSelect().getValue();t.load({url:i.generate("ekyna_cms_page_admin_new_child",{pageId:n}),method:"GET"}),a(t).on("ekyna.modal.response",function(e){var t;"json"==e.contentType&&(e.preventDefault(),t=e.content,o.loadPagesList(o.mainToolbar.getLocaleSelect().getValue()).then(function(){return o.updateDocumentControls(t.id)}),e.modal.close())})},c.prototype.onEditPageClick=function(e){var o=this,t=new l,n=this.mainToolbar.getPageSelect().getValue();t.load({url:i.generate("ekyna_cms_page_admin_edit",{pageId:n}),method:"GET"}),a(t).on("ekyna.modal.response",function(e){var t;"json"==e.contentType&&(e.preventDefault(),t=e.content,o.loadPagesList(o.mainToolbar.getLocaleSelect().getValue()).then(function(){return o.updateDocumentControls(t.id)}),e.modal.close())})},c.prototype.updateDocumentControls=function(e,t){void 0===t&&(t=!0);var o=this.mainToolbar.getNewPageButton(),n=this.mainToolbar.getEditPageButton(),a=this.mainToolbar.getPageSelect(),i=null;o.disable(),n.disable();try{a.select(e),i=a.getActiveChoice()}catch(e){}return i?(n.enable(),i.data.locked||o.enable(),t&&this.viewport.load(i.data.path)):(o.disable(),n.disable()),i},c});