define(["require","exports","jquery","routing","ekyna-modal","./dispatcher","./controls","./viewport","./document-manager"],function(a,b,c,d,e,f,g,h,i){"use strict";var j=function(){function a(a){var b=this;this.config=a,this.onLocaleSelectChangeHandler=function(a){return b.onLocaleSelectChange(a)},this.onPageSelectChangeHandler=function(a){return b.onPageSelectChange(a)},this.onDocumentDataHandler=function(a){return b.onDocumentData(a)},this.onNewPageClickHandler=function(a){return b.onNewPageClick(a)},this.onEditPageClickHandler=function(a){return b.onEditPageClick(a)}}return a.prototype.init=function(){i.PluginManager.load(k.plugins),this.documentManager=new i.DocumentManager(k.hostname),this.documentManager.initialize(),this.mainToolbar=new g.MainToolbarView({model:new g.MainToolbar({id:"editor-control-bar",classes:["horizontal"]},{viewports:k.viewports,locales:k.locales})}),c("[data-controls-placeholder]").replaceWith(this.mainToolbar.$el),this.mainToolbar.render(),this.viewport=new h.ViewportView({model:new h.ViewportModel}),c("[data-viewport-placeholder]").replaceWith(this.viewport.render().$el),this.initHandlers(),this.viewport.initIFrame(k.path)},a.prototype.setBusy=function(a){a&&a.defaultPrevented||this.mainToolbar.model.getControl("default","reload").activate().startSpinning()},a.prototype.unsetBusy=function(){this.mainToolbar.model.getControl("default","reload").deactivate().stopSpinning()},a.prototype.initHandlers=function(){var a=this;f["default"].on("controls.power.click",this.documentManager.powerClickHandler),f["default"].on("controls.reload.click",this.viewport.onControlsReloadClickHandler),f["default"].on("controls.viewport.click",this.viewport.onControlsViewportClickHandler),f["default"].on("controls.locale.change",this.onLocaleSelectChangeHandler),f["default"].on("controls.page.change",this.onPageSelectChangeHandler),f["default"].on("controls.new_page.click",this.onNewPageClickHandler),f["default"].on("controls.edit_page.click",this.onEditPageClickHandler),f["default"].on("viewport_iframe.unload",this.documentManager.viewportUnloadHandler),f["default"].on("viewport_iframe.unload",function(b){return a.setBusy(b)}),f["default"].on("viewport_iframe.load",this.documentManager.viewportLoadHandler),f["default"].on("viewport_iframe.load",function(){return a.unsetBusy()}),f["default"].on("document_manager.navigate",this.viewport.onDocumentManagerNavigateHandler),f["default"].on("document_manager.document_data",this.onDocumentDataHandler),f["default"].on("ui.control.render",function(){a.mainToolbar.postRender()})},a.prototype.loadPagesList=function(a){var b=this.mainToolbar.getPageSelect(),e=c.ajax({url:d.generate("ekyna_cms_editor_pages_list",{document_locale:a}),method:"GET",dataType:"json"});return e.done(function(a){b.setChoices(a)}),e.fail(function(){throw"Failed to load page list."}),e},a.prototype.onLocaleSelectChange=function(a){var b=this,c=this.mainToolbar.getPageSelect(),d=c.getActiveChoice().value;this.loadPagesList(a.getActiveChoice().value).then(function(){return b.updateDocumentControls(d)})},a.prototype.onPageSelectChange=function(a){this.viewport.load(a.getActiveChoice().data.path)},a.prototype.onDocumentData=function(a){var b=this,c=this.mainToolbar.getLocaleSelect(),d=this.mainToolbar.getPageSelect(),e=c.get("value");c.select(a.locale),a.locale!=e||0==d.get("choices").length?this.loadPagesList(a.locale).then(function(){return b.updateDocumentControls(a.id,!1)}):a.id&&this.updateDocumentControls(a.id,!1)},a.prototype.onNewPageClick=function(a){var b=this,f=new e,g=this.mainToolbar.getPageSelect().getValue();f.load({url:d.generate("ekyna_cms_page_admin_new_child",{pageId:g}),method:"GET"}),c(f).on("ekyna.modal.response",function(a){if("json"==a.contentType){a.preventDefault();var c=a.content;b.loadPagesList(b.mainToolbar.getLocaleSelect().getValue()).then(function(){return b.updateDocumentControls(c.id)})}})},a.prototype.onEditPageClick=function(a){var b=this,f=new e,g=this.mainToolbar.getPageSelect().getValue();f.load({url:d.generate("ekyna_cms_page_admin_edit",{pageId:g}),method:"GET"}),c(f).on("ekyna.modal.response",function(a){if("json"==a.contentType){a.preventDefault();var c=a.content;b.loadPagesList(b.mainToolbar.getLocaleSelect().getValue()).then(function(){return b.updateDocumentControls(c.id)})}})},a.prototype.updateDocumentControls=function(a,b){this.mainToolbar.getEditPageButton().disable(),this.mainToolbar.getNewPageButton().disable();var c=this.mainToolbar.getPageSelect();b=!!b||c.select(a);var d=c.getActiveChoice();return d&&(b&&this.viewport.load(d.data.path),this.mainToolbar.getEditPageButton().enable(),!d.data.locked)?void this.mainToolbar.getNewPageButton().enable():void 0},a}(),k=c(".cms-editor").data("config"),l=new j(k);return l.init(),l});