define(["require","exports","jquery","./Dispatcher","./Ui"],function(a,b,c,d,e){"use strict";var f=a("routing"),g=function(){function a(){}return a.setDocument=function(a){this.$document=a},a.findElementById=function(a){return this.$document.find("#"+a)},a.createElement=function(a,b){if(!b)throw"Undefined parent.";return c("<div></div>").attr("id",a).appendTo(b)},a.findOrCreateElement=function(a,b){var c=this.findElementById(a);return 0==c.length&&(c=this.createElement(a,b)),c},a.setElementAttributes=function(a,b){a.removeAttr("class").attr("class",b.classes).removeAttr("data-cms").data("cms",b.data)},a.sortChildren=function(a){var b=a.children();b.detach().get().sort(function(a,b){var d=c(a).data("cms").position,e=c(b).data("cms").position;return d==e?d>e?1:-1:0}),a.append(b)},a.request=function(a){c.ajax({url:a,method:"POST"}).done(function(a){a.hasOwnProperty("content")?h.parse(a.content):a.hasOwnProperty("containers")?i.parse(a.containers):a.hasOwnProperty("rows")?j.parse(a.rows):a.hasOwnProperty("blocks")&&k.parse(a.blocks),d["default"].trigger("base_manager.response_parsed")}).fail(function(){console.log("Editor request failed.")})},a}(),h=function(){function a(){}return a.parse=function(a){a.hasOwnProperty("containers")&&i.parse(a.containers)},a}(),i=function(){function a(){}return a.parse=function(a){a.forEach(function(a){a.hasOwnProperty("rows")&&j.parse(a.rows)})},a}(),j=function(){function a(){}return a.parse=function(a,b){a.forEach(function(a){if(!a.hasOwnProperty("attributes"))throw"Unexpected row data";var c=g.findOrCreateElement(a.attributes.id,b);g.setElementAttributes(c,a.attributes),a.hasOwnProperty("blocks")&&k.parse(a.blocks,c),g.sortChildren(c)})},a}(),k=function(){function a(){}return a.parse=function(a,b){a.forEach(function(a){if(!a.hasOwnProperty("attributes"))throw"Unexpected block data";var c=g.findOrCreateElement(a.attributes.id,b);if(g.setElementAttributes(c,a.attributes),a.hasOwnProperty("plugin_attributes")){var d=g.findOrCreateElement(a.plugin_attributes.id,c);g.setElementAttributes(d,a.plugin_attributes),a.hasOwnProperty("content")&&d.html(a.content)}})},a.edit=function(a){},a.remove=function(a){},a.add=function(a){var b=a.closest(".cms-row");if(1!=b.length)throw"Block row not found.";var c=b.data("cms").id;if(!c)throw"Invalid id";g.request(f.generate("ekyna_cms_editor_row_create_block",{rowId:c}))},a.moveLeft=function(a){},a.moveRight=function(a){},a.moveUp=function(a){},a.moveDown=function(a){},a.expand=function(a){},a.compress=function(a){},a}();d["default"].on("block.edit",function(a){return k.edit(a.get("data").$block)}),d["default"].on("block.remove",function(a){return k.remove(a.get("data").$block)}),d["default"].on("block.add",function(a){return k.add(a.get("data").$block)}),d["default"].on("block.move-left",function(a){return k.moveLeft(a.get("data").$block)}),d["default"].on("block.move-right",function(a){return k.moveRight(a.get("data").$block)}),d["default"].on("block.move-up",function(a){return k.moveUp(a.get("data").$block)}),d["default"].on("block.move-down",function(a){return k.moveDown(a.get("data").$block)}),d["default"].on("block.expand",function(a){return k.expand(a.get("data").$block)}),d["default"].on("block.compress",function(a){return k.compress(a.get("data").$block)});var l=function(){function a(a){var b=this;this.enabled=!1,this.hostname=a,this.viewportOrigin={top:50,left:0},this.$document=null,this.selectionId=null,this.powerClickHandler=function(a){return b.onPowerClick(a)},this.viewportLoadHandler=function(a){return b.onViewportLoad(a)},this.viewportUnloadHandler=function(){return b.onViewportUnload()},this.documentClickHandler=function(a){return b.onDocumentClick(a)}}return a.prototype.initialize=function(){var a=this;d["default"].on("controls.power.click",this.powerClickHandler),d["default"].on("viewport_iframe.load",this.viewportLoadHandler),d["default"].on("viewport_iframe.unload",this.viewportUnloadHandler),d["default"].on("viewport.resize",function(b){return a.onViewportResize(b)}),d["default"].on("base_manager.response_parsed",function(){return a.highlightSelection()})},a.prototype.onPowerClick=function(a){var b=a.get("active");b&&!this.enabled?(this.enabled=!0,this.enableEdition()):this.enabled&&!b?(this.enabled=!1,this.disableEdition()):this.enabled=b},a.prototype.highlightSelection=function(){this.selectionId&&this.$document.find("#"+this.selectionId).addClass("selected")},a.prototype.onDocumentClick=function(a){var b,d={top:a.clientY,left:a.clientX},f=c(a.target);if(0<f.closest("#editor-document-toolbar").length)return null;if(0<f.parents(".mce-container").length)return null;this.toolbar&&this.toolbar.remove(),this.selectionId&&(this.$document.find("#"+this.selectionId).removeClass("selected"),this.selectionId=null);var g=f.closest(".cms-block");1==g.length?(console.log("Block selection"),b=this.createBlockToolbar(d,g)):(g=f.closest(".cms-row"),1==g.length?(console.log("Row selection"),b=this.createRowToolbar(d,g)):(g=f.closest(".cms-container"),1==g.length&&(console.log("Container selection"),b=this.createContainerToolbar(d,g)))),g.length&&(this.selectionId=g.attr("id"),this.highlightSelection()),b&&(this.toolbar=new e.ToolbarView({model:b}),c(document).find("body").append(this.toolbar.render().applyOriginOffset(this.viewportOrigin).$el))},a.prototype.createBlockToolbar=function(a,b){var c=new e.Toolbar({origin:a});return c.addButton("default",new e.Button({name:"edit",title:"Edit",icon:"pencil",event:"block.edit",data:{$block:b}})),c.addButton("default",new e.Button({name:"add",title:"Add",icon:"plus",event:"block.add",data:{$block:b}})),c.addButton("default",new e.Button({name:"remove",title:"Remove",icon:"remove",event:"block.remove",data:{$block:b}})),c.addButton("move",new e.Button({name:"move-left",title:"Move left",icon:"arrow-left",event:"block.move-left",data:{$block:b}})),c.addButton("move",new e.Button({name:"move-right",title:"Move right",icon:"arrow-right",event:"document.move-right",data:{$block:b}})),c.addButton("move",new e.Button({name:"move-up",title:"Move up",icon:"arrow-up",event:"block.move-up",data:{$block:b}})),c.addButton("move",new e.Button({name:"move-down",title:"Move down",icon:"arrow-down",event:"block.move-down",data:{$block:b}})),c.addButton("resize",new e.Button({name:"expand",title:"Expand size",icon:"expand",event:"block.expand",data:{$block:b}})),c.addButton("resize",new e.Button({name:"compress",title:"Compress size",icon:"compress",event:"block.compress",data:{$block:b}})),c},a.prototype.createRowToolbar=function(a,b){var c=new e.Toolbar({origin:a});return c.addButton("move",new e.Button({name:"move-up",title:"Move up",icon:"arrow-up",event:"move-block-up",data:{$row:b}})),c.addButton("move",new e.Button({name:"move-down",title:"Move down",icon:"arrow-down",event:"move-block-down",data:{$row:b}})),c.addButton("add",new e.Button({name:"Add",title:"Add after",icon:"plus",event:"add-row",data:{$row:b}})),c},a.prototype.createContainerToolbar=function(a,b){var c=new e.Toolbar({origin:a});return c.addButton("move",new e.Button({name:"move-up",title:"Move up",icon:"arrow-up",event:"move-block-up",data:{$container:b}})),c.addButton("move",new e.Button({name:"move-down",title:"Move down",icon:"arrow-down",event:"move-block-down",data:{$container:b}})),c.addButton("add",new e.Button({name:"Add",title:"Add after",icon:"plus",event:"add-row",data:{$container:b}})),c},a.prototype.onViewportLoad=function(a){var b=this;return this.$document=c(a),g.setDocument(this.$document),this.$document.find("a[href]").off("click").on("click",function(a){a.preventDefault(),a.stopPropagation();var c=a.currentTarget;c.hostname!==b.hostname?console.log("Attempt to navigate out of the website has been blocked."):d["default"].trigger("document_manager.navigate",c.href)}),this.enabled&&this.enableEdition(),this},a.prototype.onViewportUnload=function(){return this.$document=null,g.setDocument(null),this},a.prototype.onViewportResize=function(a){return this.viewportOrigin=a,this.toolbar&&this.toolbar.applyOriginOffset(a),this},a.prototype.enableEdition=function(){if(this.enabled&&null!==this.$document){if(0==this.$document.find("link#cms-editor-stylesheet").length){console.log("Document editor stylesheet not found.");var a=document.createElement("link");a.id="cms-editor-stylesheet",a.href="/bundles/ekynacms/css/editor-document.css",a.type="text/css",a.rel="stylesheet",this.$document.find("head").append(a)}else console.log("Document editor stylesheet found.");return this.$document.on("click",this.documentClickHandler),this}},a.prototype.disableEdition=function(){if(!this.enabled&&null!==this.$document){this.toolbar&&this.toolbar.remove(),this.$document.off("click",this.documentClickHandler);var a=this.$document.find("link#cms-editor-stylesheet");return a.length&&a.remove(),this}},a}();b.DocumentManager=l});