define(["require","exports","jquery","./Dispatcher","./Ui"],function(a,b,c,d,e){"use strict";var f=function(){function a(a){var b=this;this.enabled=!1,this.hostname=a,this.$document=null,this.powerClickHandler=function(a){return b.onPowerClick(a)},this.viewportLoadHandler=function(a){return b.onViewportLoad(a)},this.viewportUnloadHandler=function(){return b.onViewportUnload()},this.documentClickHandler=function(a){return b.onDocumentClick(a)}}return a.prototype.initialize=function(){d["default"].on("controls.power.click",this.powerClickHandler),d["default"].on("viewport_iframe.load",this.viewportLoadHandler),d["default"].on("viewport_iframe.unload",this.viewportUnloadHandler)},a.prototype.onPowerClick=function(a){var b=a.get("active");b&&!this.enabled?(this.enabled=!0,this.enableEdition()):this.enabled&&!b?(this.enabled=!1,this.disableEdition()):this.enabled=b},a.prototype.onDocumentClick=function(a){var b,d={left:a.clientX,top:a.clientY},e=c(a.target);return 0<e.closest("#editor-document-toolbar").length?null:0<e.parents(".mce-container").length?null:(this.toolbar&&this.toolbar.remove(),b=e.closest(".cms-block"),1==b.length?(console.log("Block selection"),void this.displayBlockToolbar(d,b)):(b=e.closest(".cms-row"),1==b.length?(console.log("Row selection"),void this.displayRowToolbar(d,b)):(b=e.closest(".cms-container"),1==b.length?(this.displayContainerToolbar(d,b),void console.log("Container selection")):void 0)))},a.prototype.displayBlockToolbar=function(a,b){var d=new e.Toolbar({origin:a});return d.addButton("default",new e.Button({name:"edit",title:"Edit",icon:"pencil",event:"edit-block",data:{$block:b}})),d.addButton("default",new e.Button({name:"add",title:"Add",icon:"plus",event:"add-block",data:{$block:b}})),d.addButton("default",new e.Button({name:"remove",title:"Remove",icon:"remove",event:"remove-block",data:{$block:b}})),d.addButton("move",new e.Button({name:"move-left",title:"Move left",icon:"arrow-left",event:"move-block-left",data:{$block:b}})),d.addButton("move",new e.Button({name:"move-right",title:"Move right",icon:"arrow-right",event:"move-block-right",data:{$block:b}})),d.addButton("move",new e.Button({name:"move-up",title:"Move up",icon:"arrow-up",event:"move-block-up",data:{$block:b}})),d.addButton("move",new e.Button({name:"move-down",title:"Move down",icon:"arrow-down",event:"move-block-down",data:{$block:b}})),d.addButton("resize",new e.Button({name:"expand",title:"Expand size",icon:"expand",event:"expand-block",data:{$block:b}})),d.addButton("resize",new e.Button({name:"compress",title:"Compress size",icon:"compress",event:"compress-block",data:{$block:b}})),this.toolbar=new e.ToolbarView({model:d}),c(document).find("body").append(this.toolbar.render().$el),this},a.prototype.displayRowToolbar=function(a,b){var d=new e.Toolbar({origin:a});return d.addButton("move",new e.Button({name:"move-up",title:"Move up",icon:"arrow-up",event:"move-block-up",data:{$row:b}})),d.addButton("move",new e.Button({name:"move-down",title:"Move down",icon:"arrow-down",event:"move-block-down",data:{$row:b}})),d.addButton("add",new e.Button({name:"Add",title:"Add after",icon:"plus",event:"add-row",data:{$row:b}})),this.toolbar=new e.ToolbarView({model:d}),c(document).find("body").append(this.toolbar.render().$el),this},a.prototype.displayContainerToolbar=function(a,b){var d=new e.Toolbar({origin:a});return d.addButton("move",new e.Button({name:"move-up",title:"Move up",icon:"arrow-up",event:"move-block-up",data:{$container:b}})),d.addButton("move",new e.Button({name:"move-down",title:"Move down",icon:"arrow-down",event:"move-block-down",data:{$container:b}})),d.addButton("add",new e.Button({name:"Add",title:"Add after",icon:"plus",event:"add-row",data:{$container:b}})),this.toolbar=new e.ToolbarView({model:d}),c(document).find("body").append(this.toolbar.render().$el),this},a.prototype.onViewportLoad=function(a){var b=this;return this.$document=c(a),this.$document.find("a[href]").off("click").on("click",function(a){a.preventDefault(),a.stopPropagation();var c=a.currentTarget;c.hostname!==b.hostname?console.log("Attempt to navigate out of the website has been blocked."):d["default"].trigger("document_manager.navigate",c.href)}),this.enabled&&this.enableEdition(),this},a.prototype.onViewportUnload=function(){return this.$document=null,this},a.prototype.enableEdition=function(){if(this.enabled&&null!==this.$document){if(0==this.$document.find("link#cms-editor-stylesheet").length){console.log("Document editor stylesheet not found.");var a=document.createElement("link");a.id="cms-editor-stylesheet",a.href="/bundles/ekynacms/css/editor-document.css",a.type="text/css",a.rel="stylesheet",this.$document.find("head").append(a)}else console.log("Document editor stylesheet found.");return this.$document.on("click",this.documentClickHandler),this}},a.prototype.disableEdition=function(){if(!this.enabled&&null!==this.$document){this.toolbar&&this.toolbar.remove(),this.$document.off("click",this.documentClickHandler);var a=this.$document.find("link#cms-editor-stylesheet");return a.length&&a.remove(),this}},a}();b.DocumentManager=f});